SET client_min_messages TO WARNING;
create table vector_test (
    id serial primary key,
    a vector(3),
    b integer
);
insert into vector_test (a,b) VALUES
    ('[1,2,3]',0),
    ('[1,2,3]',0),
    ('[1,2,3]',1),
    ('[1,2,3]',NULL),
    ('[2,3,4]',0),
    ('[2,3,4]',0),
    ('[2,3,4]',1),
    ('[2,3,4]',NULL),
    (NULL,0),
    (NULL,1),
    (NULL,NULL);
CREATE MATERIALIZED VIEW vector_test_rollup1 AS (
    SELECT
        count(a),
        vector_sum(a),
        vector_avg(a),
        vector_sum(a)/count(a)
    FROM vector_test
);
CREATE MATERIALIZED VIEW vector_test_rollup2 AS (
    SELECT
        count(a),
        vector_sum(a),
        vector_avg(a),
        vector_sum(a)/count(a),
        b
    FROM vector_test
    GROUP BY b
);
select assert_rollup('vector_test_rollup1');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('vector_test_rollup2');
 assert_rollup 
---------------
 
(1 row)

insert into vector_test (a,b) VALUES
    ('[1,2,3]',0),
    ('[1,2,3]',0),
    ('[1,2,3]',1),
    ('[1,2,3]',NULL),
    ('[2,3,4]',0),
    ('[2,3,4]',0),
    ('[2,3,4]',1),
    ('[2,3,4]',NULL),
    (NULL,0),
    (NULL,1),
    (NULL,NULL);
select assert_rollup('vector_test_rollup1');
 assert_rollup 
---------------
 
(1 row)

select assert_rollup('vector_test_rollup2');
 assert_rollup 
---------------
 
(1 row)

select * from vector_test_rollup1;
 count | vector_sum |  vector_avg   | (vector_sum(vector_test.a)/(count(vector_test.a))::real) 
-------+------------+---------------+----------------------------------------------------------
    16 | [24,40,56] | [1.5,2.5,3.5] | [1.5,2.5,3.5]
(1 row)

select * from vector_test_rollup2;
 count | vector_sum |  vector_avg   | (vector_sum(vector_test.a)/(count(vector_test.a))::real) | vector_test.b 
-------+------------+---------------+----------------------------------------------------------+---------------
     4 | [6,10,14]  | [1.5,2.5,3.5] | [1.5,2.5,3.5]                                            |              
     4 | [6,10,14]  | [1.5,2.5,3.5] | [1.5,2.5,3.5]                                            |             1
     8 | [12,20,28] | [1.5,2.5,3.5] | [1.5,2.5,3.5]                                            |             0
(3 rows)

drop table vector_test cascade;
